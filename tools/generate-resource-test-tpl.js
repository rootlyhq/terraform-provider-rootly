const inflect = require("./inflect");
const path = require("path");

module.exports = (name, resourceSchema, requiredFields, pathIdField, swagger) => {
  const namePlural = inflect.pluralize(name);
  const nameCamel = inflect.camelize(name);
  const nameCamelPlural = inflect.camelize(namePlural);

  return `// DO NOT MODIFY: This file is generated by tools/generate.js. Any changes will be overwritten during the next build.

package provider

import (
	"testing"

	"github.com/hashicorp/terraform-plugin-sdk/v2/helper/resource"
)

func TestAccResource${nameCamel}(t *testing.T) {
	resource.UnitTest(t, resource.TestCase{
		PreCheck:          func() {
			testAccPreCheck(t)
		},
		ProviderFactories: providerFactories,
		Steps: []resource.TestStep{
			{
				Config: testAccResource${nameCamel},
			},
		},
	})
}

const testAccResource${nameCamel} = \`
resource "rootly_${name}" "test" {
	${testParams(name, getCreationSchema(name, resourceSchema, swagger), requiredFields || [])}
}
\`
`;
};

function testParams(name, schema, required) {
  return required
    .filter((key) => schema.properties[key])
    .map((key) => {
      let val = schema.properties[key].enum
        ? schema.properties[key].enum[0]
        : "test";
      switch (schema.properties[key].type) {
        case "boolean":
          return `${key} = false`;
        case "string":
          if (key == "url") {
            return `	url = "https://rootly.com/dummy"`;
          } else if (key.endsWith("_id")) {
            // Handle ID fields - could be UUID string or integer
            // Use string UUID format for safety since most APIs expect strings
            return `${key} = "01234567-89ab-cdef-0123-456789abcdef"`;
          } else if (key == "color") {
            // Handle color fields with hex format (when required)
            return `${key} = "#FF0000"`;
          } else {
            return `${key} = "${val}"`;
          }
        case "number":
          return `${key} = 1`;
        case "integer":
          if (key.endsWith("_id")) {
            // Handle integer ID fields
            return `${key} = 1`;
          }
          return `${key} = 1`;
        case "array":
          if (
            schema.properties[key].items.type === "object" &&
            schema.properties[key].items.properties.id
          ) {
            return `${key} {
						id = "foo"
						name = "bar"
					}`;
          }
          return `${key} = ["foo"]`;
        case "object":
          return `${key} = {
					id = "foo"
					name = "bar"
				}`;
      }
    })
    .join("\n");
}

function getCreationSchema(name, resourceSchema, swagger) {
  // Try to get the creation schema (new_*) first, fallback to resource schema
  const creationSchemaName = `new_${name}`;
  if (swagger.components && swagger.components.schemas && swagger.components.schemas[creationSchemaName]) {
    const creationSchema = swagger.components.schemas[creationSchemaName];
    // Navigate to the attributes properties in the creation schema
    if (creationSchema.properties && 
        creationSchema.properties.data && 
        creationSchema.properties.data.properties && 
        creationSchema.properties.data.properties.attributes &&
        creationSchema.properties.data.properties.attributes.properties) {
      return creationSchema.properties.data.properties.attributes;
    }
  }
  // Fallback to resource schema if creation schema not found or malformed
  return resourceSchema;
}
