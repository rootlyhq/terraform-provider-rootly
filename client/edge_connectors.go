// DO NOT MODIFY: This file is generated by tools/generate.js. Any changes will be overwritten during the next build.

package client

import (
	"bytes"
	"encoding/json"
	"fmt"
	"io"

	rootlygo "github.com/rootlyhq/terraform-provider-rootly/v2/schema"
)

type EdgeConnector struct {
	ID   string                 `json:"-"`
	Data map[string]interface{} `json:"-"`
}

// edgeConnectorAPIRequest is the JSON:API request body for create/update
type edgeConnectorAPIRequest struct {
	Data edgeConnectorAPIRequestData `json:"data"`
}

type edgeConnectorAPIRequestData struct {
	Type       string                 `json:"type"`
	ID         string                 `json:"id,omitempty"`
	Attributes map[string]interface{} `json:"attributes"`
}

// edgeConnectorAPIResponse is the JSON:API response from the server
type edgeConnectorAPIResponse struct {
	Data struct {
		ID         string                 `json:"id"`
		Type       string                 `json:"type"`
		Attributes map[string]interface{} `json:"attributes"`
	} `json:"data"`
}

type edgeConnectorListAPIResponse struct {
	Data []struct {
		ID         string                 `json:"id"`
		Type       string                 `json:"type"`
		Attributes map[string]interface{} `json:"attributes"`
	} `json:"data"`
}

// marshalEdgeConnector builds the correct JSON:API request body from the Terraform nested data structure.
// Terraform stores edge connector config as: data[0].attributes[0].{name,description,status,subscriptions}
// The API expects: {"data": {"type": "edge_connectors", "attributes": {name, description, status, subscriptions}}}
func marshalEdgeConnector(ec *EdgeConnector) (io.Reader, error) {
	req := edgeConnectorAPIRequest{}
	req.Data.Type = "edge_connectors"

	if ec.Data != nil {
		if id, ok := ec.Data["id"].(string); ok && id != "" && id != "temp-id" {
			req.Data.ID = id
		}
		if attrsList, ok := ec.Data["attributes"].([]interface{}); ok && len(attrsList) > 0 {
			if attrsMap, ok := attrsList[0].(map[string]interface{}); ok {
				filtered := map[string]interface{}{}
				for _, key := range []string{"name", "description", "status", "subscriptions"} {
					if v, exists := attrsMap[key]; exists {
						switch val := v.(type) {
						case string:
							if val != "" {
								filtered[key] = v
							}
						default:
							if v != nil {
								filtered[key] = v
							}
						}
					}
				}
				req.Data.Attributes = filtered
			}
		}
	}

	buf, err := json.Marshal(req)
	if err != nil {
		return nil, err
	}
	return bytes.NewReader(buf), nil
}

// unmarshalEdgeConnector parses the JSON:API response and reconstructs the nested structure
// expected by the Terraform resource: Data["attributes"] must be []interface{}{map[string]interface{}{...}}
func unmarshalEdgeConnector(body io.Reader) (*EdgeConnector, error) {
	var resp edgeConnectorAPIResponse
	if err := json.NewDecoder(body).Decode(&resp); err != nil {
		return nil, err
	}

	ec := &EdgeConnector{
		ID: resp.Data.ID,
		Data: map[string]interface{}{
			"type":       resp.Data.Type,
			"id":         resp.Data.ID,
			"attributes": []interface{}{resp.Data.Attributes},
		},
	}
	return ec, nil
}

func (c *Client) ListEdgeConnectors(params *rootlygo.ListEdgeConnectorsParams) ([]interface{}, error) {
	req, err := rootlygo.NewListEdgeConnectorsRequest(c.Rootly.Server, params)
	if err != nil {
		return nil, fmt.Errorf("Error building request: %w", err)
	}

	resp, err := c.Do(req)
	if err != nil {
		return nil, fmt.Errorf("Failed to make request: %w", err)
	}
	defer resp.Body.Close()

	var listResp edgeConnectorListAPIResponse
	if err := json.NewDecoder(resp.Body).Decode(&listResp); err != nil {
		return nil, fmt.Errorf("Error unmarshaling: %w", err)
	}

	results := make([]interface{}, 0, len(listResp.Data))
	for _, item := range listResp.Data {
		ec := &EdgeConnector{
			ID: item.ID,
			Data: map[string]interface{}{
				"type":       item.Type,
				"id":         item.ID,
				"attributes": []interface{}{item.Attributes},
			},
		}
		results = append(results, ec)
	}
	return results, nil
}

func (c *Client) CreateEdgeConnector(d *EdgeConnector) (*EdgeConnector, error) {
	buffer, err := marshalEdgeConnector(d)
	if err != nil {
		return nil, fmt.Errorf("Error marshaling edge_connector: %w", err)
	}

	req, err := rootlygo.NewCreateEdgeConnectorRequestWithBody(c.Rootly.Server, c.ContentType, buffer)
	if err != nil {
		return nil, fmt.Errorf("Error building request: %w", err)
	}
	resp, err := c.Do(req)
	if err != nil {
		return nil, fmt.Errorf("Failed to perform request to create edge_connector: %s", err)
	}
	defer resp.Body.Close()

	ec, err := unmarshalEdgeConnector(resp.Body)
	if err != nil {
		return nil, fmt.Errorf("Error unmarshaling edge_connector: %w", err)
	}

	return ec, nil
}

func (c *Client) GetEdgeConnector(id string) (*EdgeConnector, error) {
	req, err := rootlygo.NewGetEdgeConnectorRequest(c.Rootly.Server, id)
	if err != nil {
		return nil, fmt.Errorf("Error building request: %w", err)
	}

	resp, err := c.Do(req)
	if err != nil {
		return nil, fmt.Errorf("Failed to make request to get edge_connector: %w", err)
	}
	defer resp.Body.Close()

	ec, err := unmarshalEdgeConnector(resp.Body)
	if err != nil {
		return nil, fmt.Errorf("Error unmarshaling edge_connector: %w", err)
	}

	return ec, nil
}

func (c *Client) UpdateEdgeConnector(id string, edge_connector *EdgeConnector) (*EdgeConnector, error) {
	buffer, err := marshalEdgeConnector(edge_connector)
	if err != nil {
		return nil, fmt.Errorf("Error marshaling edge_connector: %w", err)
	}

	req, err := rootlygo.NewUpdateEdgeConnectorRequestWithBody(c.Rootly.Server, id, c.ContentType, buffer)
	if err != nil {
		return nil, fmt.Errorf("Error building request: %w", err)
	}
	resp, err := c.Do(req)
	if err != nil {
		return nil, fmt.Errorf("Failed to make request to update edge_connector: %w", err)
	}
	defer resp.Body.Close()

	ec, err := unmarshalEdgeConnector(resp.Body)
	if err != nil {
		return nil, fmt.Errorf("Error unmarshaling edge_connector: %w", err)
	}

	return ec, nil
}

func (c *Client) DeleteEdgeConnector(id string) error {
	req, err := rootlygo.NewDeleteEdgeConnectorRequest(c.Rootly.Server, id)
	if err != nil {
		return fmt.Errorf("Error building request: %w", err)
	}

	_, err = c.Do(req)
	if err != nil {
		return fmt.Errorf("Failed to make request to delete edge_connector: %w", err)
	}

	return nil
}
